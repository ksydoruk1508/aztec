#!/usr/bin/env bash
# =====================================================================
#  Aztec Node ‚Äî RU/EN interactive installer/runner (Docker-based)
#  Uses the requested ASCII logo. Bilingual menus & prompts.
#  Target: Ubuntu/Debian (apt). Requires sudo privileges for installs.
#  Version: 1.2.0
# =====================================================================
set -Eeuo pipefail

# -----------------------------
# Branding / Logo (keep as requested)
# -----------------------------
display_logo() {
  cat <<'EOF'
 _   _           _  _____      
| \ | |         | ||____ |     
|  \| | ___   __| |    / /_ __ 
| . ` |/ _ \ / _` |    \ \ '__|
| |\  | (_) | (_| |.___/ / |   
\_| \_/\___/ \__,_|\____/|_|
          Aztec
     –ö–∞–Ω–∞–ª: @NodesN3R
EOF
}

# -----------------------------
# Configurable parameters
# -----------------------------
SCRIPT_NAME="AztecNode"
SCRIPT_VERSION="1.2.0"

# Paths
AZTEC_DIR="$HOME/aztec"
ENV_FILE="$AZTEC_DIR/.env"
COMPOSE_FILE="$AZTEC_DIR/docker-compose.yml"

# Docker image tag (from snippet)
AZTEC_IMAGE="aztecprotocol/aztec:1.2.1"

# -----------------------------
# Colors (toggleable)
# -----------------------------
COLOR_ENABLED=1
clrGreen='' ; clrCyan='' ; clrRed='' ; clrYellow='' ; clrReset='' ; clrBold=''
apply_colors() {
  if [[ "$COLOR_ENABLED" -eq 1 ]]; then
    clrGreen='[0;32m'
    clrCyan='[0;36m'
    clrRed='[0;31m'
    clrYellow='[1;33m'
    clrReset='[0m'
    clrBold='[1m'
  else
    clrGreen='' ; clrCyan='' ; clrRed='' ; clrYellow='' ; clrReset='' ; clrBold=''
  fi
}
apply_colors

ok()    { echo -e "${clrGreen}[OK] $1${clrReset}"; }
info()  { echo -e "${clrCyan}[INFO] $1${clrReset}"; }
warn()  { echo -e "${clrYellow}[WARN] $1${clrReset}"; }
err()   { echo -e "${clrRed}[ERROR] $1${clrReset}"; }

# -----------------------------
# Language (RU/EN)
# -----------------------------
LANG_CHOICE="ru"  # default

choose_language() {
  clear; display_logo
  echo -e "
${clrBold}Select language / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:${clrReset}"
  echo "1) –†—É—Å—Å–∫–∏–π"
  echo "2) English"
  read -rp "> " ans
  case "$ans" in
    2) LANG_CHOICE="en" ;;
    *) LANG_CHOICE="ru" ;;
  esac
}

tr() {
  # $1 = key
  local k="$1"
  case "$LANG_CHOICE" in
    en)
      case "$k" in
        root_enabled) echo "‚Ä¢ Root Access Enabled ‚úî" ;;
        updating) echo "Updating packages..." ;;
        installing_deps) echo "Installing base dependencies..." ;;
        deps_done) echo "Base dependencies installed" ;;
        docker_setup) echo "Installing Docker (engine + compose plugin)..." ;;
        docker_done) echo "Docker installed" ;;
        ufw_setup) echo "Configuring firewall (UFW)..." ;;
        ufw_warn_enable) echo "UFW will be enabled; ensure SSH (22) is allowed to avoid lockout." ;;
        ufw_done) echo "Firewall rules applied" ;;
        make_dir) echo "Creating and entering ./aztec directory" ;;
        ask_eth_rpc) echo "Enter Ethereum Sepolia RPC URL (ETHEREUM_RPC_URL):" ;;
        ask_beacon) echo "Enter Consensus Beacon RPC URL (CONSENSUS_BEACON_URL):" ;;
        ask_priv) echo "Enter VALIDATOR_PRIVATE_KEYS (0x-prefixed private key):" ;;
        ask_coinbase) echo "Enter COINBASE (your L1 address):" ;;
        ask_p2p) echo "Enter P2P_IP (your public IP; leave blank to auto-detect):" ;;
        env_saved) echo ".env saved" ;;
        compose_saved) echo "docker-compose.yml saved" ;;
        starting) echo "Starting Aztec node (docker compose up -d)..." ;;
        started) echo "Aztec node started" ;;
        restarting) echo "Restarting Aztec node..." ;;
        restarted) echo "Aztec node restarted" ;;
        logs_hint) echo "Showing live logs (last 1000 lines). Press Ctrl+C to stop viewing." ;;
        menu_title) echo "Aztec Node ‚Äî Installer & Manager" ;;
        m1_bootstrap) echo "One‚Äëclick setup: update packages, deps, Docker & UFW" ;;
        m2_create) echo "Create ./aztec, fill .env, and write docker-compose.yml" ;;
        m3_start) echo "Start node (docker compose up -d)" ;;
        m4_restart) echo "Restart node (docker compose restart)" ;;
        m4_logs) echo "Follow logs" ;;
        m5_sync) echo "Run sync status check (Cerberus-Node)" ;;
        m6_rpc) echo "Check your RPC health" ;;
        m7_remove) echo "Remove node & data" ;;
        m8_lang) echo "Change language / –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫" ;;
        m9_colors) echo "Toggle colors On/Off" ;;
        m10_exit) echo "Exit" ;;
        press_enter) echo "Press Enter to return to menu..." ;;
        sync_running) echo "Running sync status script..." ;;
        rpc_running) echo "Running RPC health check..." ;;
        need_root_warn) echo "Some steps require sudo/root. You'll be prompted when needed." ;;
        docker_missing) echo "Docker is not available. Please run the one‚Äëclick setup first." ;;
        remove_confirm) echo "This will stop and remove containers, volumes and delete the ./aztec folder. Type 'yes' to confirm:" ;;
        keep_env_q) echo "Keep .env as backup? [Y/n]:" ;;
        backup_saved) echo "Backup saved to" ;;
        removed_ok) echo "Node and data removed" ;;
        cancelled) echo "Cancelled" ;;
        dir_missing) echo "Directory not found" ;;
        colors_on) echo "Colors: ENABLED" ;;
        colors_off) echo "Colors: DISABLED" ;;
        *) echo "$k" ;;
      esac
      ;;
    *)
      case "$k" in
        root_enabled) echo "‚Ä¢ Root Access Enabled ‚úî" ;;
        updating) echo "–û–±–Ω–æ–≤–ª—è—é –ø–∞–∫–µ—Ç—ã..." ;;
        installing_deps) echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..." ;;
        deps_done) echo "–ë–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" ;;
        docker_setup) echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker (–¥–≤–∏–∂–æ–∫ + compose‚Äë–ø–ª–∞–≥–∏–Ω)..." ;;
        docker_done) echo "Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" ;;
        ufw_setup) echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é firewall (UFW)..." ;;
        ufw_warn_enable) echo "–ë—É–¥–µ—Ç –≤–∫–ª—é—á—ë–Ω UFW; —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH (22) —Ä–∞–∑—Ä–µ—à—ë–Ω, –∏–Ω–∞—á–µ –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –¥–æ—Å—Ç—É–ø." ;;
        ufw_done) echo "–ü—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã" ;;
        make_dir) echo "–°–æ–∑–¥–∞—é –∏ –ø–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é ./aztec" ;;
        ask_eth_rpc) echo "–í–≤–µ–¥–∏—Ç–µ Sepolia RPC (ETHEREUM_RPC_URL):" ;;
        ask_beacon) echo "–í–≤–µ–¥–∏—Ç–µ Beacon RPC (CONS–ï–ùSUS_BEACON_URL):" ;;
        ask_priv) echo "–í–≤–µ–¥–∏—Ç–µ VALIDATOR_PRIVATE_KEYS (–ø—Ä–∏–≤–∞—Ç–Ω–∏–∫ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º 0x):" ;;
        ask_coinbase) echo "–í–≤–µ–¥–∏—Ç–µ COINBASE (–≤–∞—à L1 –∞–¥—Ä–µ—Å):" ;;
        ask_p2p) echo "–í–≤–µ–¥–∏—Ç–µ P2P_IP (–≤–∞—à –ø—É–±–ª–∏—á–Ω—ã–π IP; –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è):" ;;
        env_saved) echo ".env —Å–æ—Ö—Ä–∞–Ω—ë–Ω" ;;
        compose_saved) echo "docker-compose.yml —Å–æ—Ö—Ä–∞–Ω—ë–Ω" ;;
        starting) echo "–ó–∞–ø—É—Å–∫–∞—é —É–∑–µ–ª (docker compose up -d)..." ;;
        started) echo "–£–∑–µ–ª –∑–∞–ø—É—â–µ–Ω" ;;
        restarting) echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —É–∑–µ–ª Aztec..." ;;
        restarted) echo "–£–∑–µ–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω" ;;
        logs_hint) echo "–ü–æ–∫–∞–∑—ã–≤–∞—é –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫). –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞." ;;
        menu_title) echo "Aztec Node ‚Äî —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä" ;;
        m1_bootstrap) echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞ —Ä–∞–∑: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, Docker –∏ UFW" ;;
        m2_create) echo "–°–æ–∑–¥–∞—Ç—å ./aztec, –∑–∞–ø–æ–ª–Ω–∏—Ç—å .env –∏ –∑–∞–ø–∏—Å–∞—Ç—å docker-compose.yml" ;;
        m3_start) echo "–ó–∞–ø—É—Å—Ç–∏—Ç—å —É–∑–µ–ª (docker compose up -d)" ;;
        m4_restart) echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —É–∑–µ–ª \(docker compose restart\)" ;;
        m4_logs) echo "–°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏" ;;
        m5_sync) echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (—Å–∫—Ä–∏–ø—Ç Cerberus‚ÄëNode)" ;;
        m6_rpc) echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –≤–∞—à–µ–≥–æ RPC" ;;
        m7_remove) echo "–£–¥–∞–ª–∏—Ç—å –Ω–æ–¥—É –∏ –¥–∞–Ω–Ω—ã–µ" ;;
        m8_lang) echo "–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ / Change language" ;;
        m9_colors) echo "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ü–≤–µ—Ç–∞ (–≤–∫–ª/–≤—ã–∫–ª)" ;;
        m10_exit) echo "–í—ã—Ö–æ–¥" ;;
        press_enter) echo "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é..." ;;
        sync_running) echo "–ó–∞–ø—É—Å–∫–∞—é —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..." ;;
        rpc_running) echo "–ó–∞–ø—É—Å–∫–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É –∑–¥–æ—Ä–æ–≤—å—è RPC..." ;;
        need_root_warn) echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —à–∞–≥–∏ —Ç—Ä–µ–±—É—é—Ç sudo/root. –í–∞—Å –ø–æ–ø—Ä–æ—Å—è—Ç –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏." ;;
        docker_missing) echo "Docker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –æ–¥–Ω–∏–º —à–∞–≥–æ–º." ;;
        remove_confirm) echo "–ë—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —É–¥–∞–ª—ë–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ç–æ–º–∞–º–∏ –∏ —É–¥–∞–ª–µ–Ω–∞ –ø–∞–ø–∫–∞ ./aztec. –í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:" ;;
        keep_env_q) echo "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å .env –≤ –±—ç–∫–∞–ø? [Y/n]:" ;;
        backup_saved) echo "–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ –ø—É—Ç–∏" ;;
        removed_ok) echo "–ù–æ–¥–∞ –∏ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã" ;;
        cancelled) echo "–û—Ç–º–µ–Ω–µ–Ω–æ" ;;
        dir_missing) echo "–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω" ;;
        colors_on) echo "–¶–≤–µ—Ç–∞: –í–ö–õ" ;;
        colors_off) echo "–¶–≤–µ—Ç–∞: –í–´–ö–õ" ;;
        *) echo "$k" ;;
      esac
      ;;
  esac
}

# -----------------------------
# Helpers
# -----------------------------
need_sudo() {
  if [[ $(id -u) -ne 0 ]] && ! command -v sudo >/dev/null 2>&1; then
    err "sudo –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–¥ root –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ sudo."
    exit 1
  fi
}
run() {
  # Run with sudo when necessary
  if [[ $(id -u) -ne 0 ]]; then sudo bash -lc "$*"; else bash -lc "$*"; fi
}

toggle_colors() {
  if [[ "$COLOR_ENABLED" -eq 1 ]]; then COLOR_ENABLED=0; apply_colors; info "$(tr colors_off)"; else COLOR_ENABLED=1; apply_colors; info "$(tr colors_on)"; fi
}

# -----------------------------
# Update & base deps
# -----------------------------
update_and_deps() {
  echo "$(tr root_enabled)"
  info "$(tr updating)"; run "apt-get update && apt-get upgrade -y"
  info "$(tr installing_deps)"
  run "apt-get install -y curl iptables build-essential git wget lz4 jq make gcc nano automake autoconf tmux htop nvme-cli libgbm1 pkg-config libssl-dev libleveldb-dev tar clang bsdmainutils ncdu unzip ufw screen gawk"
  ok "$(tr deps_done)"
}

# -----------------------------
# Docker install (engine + compose plugin)
# -----------------------------
install_docker() {
  info "$(tr docker_setup)"; need_sudo
  # Try distro packages first (Ubuntu 22.04+ has docker.io + docker-compose-plugin)
  if ! command -v docker >/dev/null 2>&1; then
    run "apt-get update && apt-get install -y docker.io"
  fi
  if ! docker compose version >/dev/null 2>&1; then
    run "apt-get install -y docker-compose-plugin"
  fi
  # Enable & start
  run "systemctl enable --now docker" || true
  docker --version || true
  docker compose version || true
  ok "$(tr docker_done)"
}

# -----------------------------
# Firewall (UFW)
# -----------------------------
setup_firewall() {
  info "$(tr ufw_setup)"; need_sudo
  echo "$(tr ufw_warn_enable)"
  run "apt-get install -y ufw > /dev/null 2>&1 || true"
  run "ufw allow 22"
  run "ufw allow ssh"
  # Sequencer ports
  run "ufw allow 40400/tcp"
  run "ufw allow 40400/udp"
  run "ufw allow 8080"
  # Enable & reload
  yes | run ufw enable || true
  run ufw reload || true
  ok "$(tr ufw_done)"
}

# -----------------------------
# One‚Äëclick bootstrap (1‚Äì3 combined)
# -----------------------------
bootstrap_setup() {
  update_and_deps
  install_docker
  setup_firewall
}

# -----------------------------
# Create dir, ask .env, write compose
# -----------------------------
create_dir_and_env_and_compose() {
  info "$(tr make_dir)"
  mkdir -p "$AZTEC_DIR"
  cd "$AZTEC_DIR"

  # Read existing values if any
  local ETHEREUM_RPC_URL="" CONSENSUS_BEACON_URL="" VALIDATOR_PRIVATE_KEYS="" COINBASE="" P2P_IP=""
  if [[ -f "$ENV_FILE" ]]; then
    # shellcheck disable=SC1090
    set -a; source "$ENV_FILE" || true; set +a
    ETHEREUM_RPC_URL="${ETHEREUM_RPC_URL:-}"
    CONSENSUS_BEACON_URL="${CONSENSUS_BEACON_URL:-}"
    VALIDATOR_PRIVATE_KEYS="${VALIDATOR_PRIVATE_KEYS:-}"
    COINBASE="${COINBASE:-}"
    P2P_IP="${P2P_IP:-}"
  fi

  read -rp "$(tr ask_eth_rpc) ${ETHEREUM_RPC_URL:+[$ETHEREUM_RPC_URL]} " ans; ETHEREUM_RPC_URL="${ans:-${ETHEREUM_RPC_URL}}"
  read -rp "$(tr ask_beacon) ${CONSENSUS_BEACON_URL:+[$CONSENSUS_BEACON_URL]} " ans; CONSENSUS_BEACON_URL="${ans:-${CONSENSUS_BEACON_URL}}"
  read -rp "$(tr ask_priv) ${VALIDATOR_PRIVATE_KEYS:+[***hidden***]} " ans; VALIDATOR_PRIVATE_KEYS="${ans:-${VALIDATOR_PRIVATE_KEYS}}"
  read -rp "$(tr ask_coinbase) ${COINBASE:+[$COINBASE]} " ans; COINBASE="${ans:-${COINBASE}}"
  local autodetect_ip="$(curl -s https://ifconfig.me || true)" || true
  read -rp "$(tr ask_p2p) ${P2P_IP:+[$P2P_IP]} " ans; P2P_IP="${ans:-${P2P_IP:-$autodetect_ip}}"

  cat > "$ENV_FILE" <<EOF
ETHEREUM_RPC_URL=${ETHEREUM_RPC_URL}
CONSENSUS_BEACON_URL=${CONSENSUS_BEACON_URL}
VALIDATOR_PRIVATE_KEYS=${VALIDATOR_PRIVATE_KEYS}
COINBASE=${COINBASE}
P2P_IP=${P2P_IP}
EOF
  ok "$(tr env_saved)"

  # docker-compose.yml from the spec
  cat > "$COMPOSE_FILE" <<'YAML'
services:
  aztec-node:
    container_name: aztec-sequencer
    image: aztecprotocol/aztec:1.2.1
    restart: unless-stopped
    network_mode: host
    environment:
      ETHEREUM_HOSTS: ${ETHEREUM_RPC_URL}
      L1_CONSENSUS_HOST_URLS: ${CONSENSUS_BEACON_URL}
      DATA_DIRECTORY: /data
      VALIDATOR_PRIVATE_KEYS: ${VALIDATOR_PRIVATE_KEYS}
      COINBASE: ${COINBASE}
      P2P_IP: ${P2P_IP}
      LOG_LEVEL: info
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --node --archiver --sequencer'
    ports:
      - 40400:40400/tcp
      - 40400:40400/udp
      - 8080:8080
    volumes:
      - /root/.aztec/alpha-testnet/data/:/data
YAML
  ok "$(tr compose_saved)"
}

# -----------------------------
# Start node
# -----------------------------
$1
# -----------------------------
# Restart node
# -----------------------------
restart_node() {
  if ! command -v docker >/dev/null 2>&1 || ! docker compose version >/dev/null 2>&1; then
    err "$(tr docker_missing)"; return 1
  fi
  cd "$AZTEC_DIR"
  info "$(tr restarting)"
  if ! docker compose restart; then
    warn "compose restart failed, doing down/up..."
    docker compose down || true
    docker compose up -d
  fi
  ok "$(tr restarted)"
}

# -----------------------------
# Logs
# -----------------------------
show_logs() {
  if ! command -v docker >/dev/null 2>&1; then err "$(tr docker_missing)"; return 1; fi
  cd "$AZTEC_DIR"
  info "$(tr logs_hint)"
  docker compose logs -fn 1000
}

# -----------------------------
# Sync status (Cerberus-Node)
# -----------------------------
run_sync_check() {
  info "$(tr sync_running)"
  bash <(curl -s https://raw.githubusercontent.com/cerberus-node/aztec-network/refs/heads/main/sync-check.sh)
}

# -----------------------------
# RPC Health Check
# -----------------------------
check_rpc_health() {
  info "$(tr rpc_running)"
  run "bash <(curl -Ls https://raw.githubusercontent.com/DeepPatel2412/Aztec-Tools/main/RPC%20Health%20Check)"
}

# -----------------------------
# Remove node & data
# -----------------------------
remove_node() {
  if [[ ! -d "$AZTEC_DIR" ]]; then warn "$(tr dir_missing): $AZTEC_DIR"; return 0; fi
  read -rp "$(tr remove_confirm) " CONF
  if [[ "$CONF" != "yes" ]]; then warn "$(tr cancelled)"; return 0; fi
  if command -v docker >/dev/null 2>&1; then
    (cd "$AZTEC_DIR" && docker compose down -v --remove-orphans) || true
  fi
  read -rp "$(tr keep_env_q) " KEEP
  if [[ -z "$KEEP" || "$KEEP" =~ ^[Yy]$ ]]; then
    if [[ -f "$ENV_FILE" ]]; then
      local TS; TS="$(date +%Y%m%d_%H%M%S)"
      cp "$ENV_FILE" "$HOME/aztec.env.$TS.bak" && ok "$(tr backup_saved) $HOME/aztec.env.$TS.bak"
    fi
  fi
  rm -rf "$AZTEC_DIR"
  ok "$(tr removed_ok)"
}

# -----------------------------
# Main menu
# -----------------------------
main_menu() {
  choose_language
  info "$(tr need_root_warn)"
  while true; do
    clear; display_logo
    echo -e "
${clrBold}$(tr menu_title)${clrReset} ‚Äî v${SCRIPT_VERSION}
"    echo "1) $(tr m1_bootstrap)"
    echo "2) $(tr m2_create)"
    echo "3) $(tr m3_start)"
    echo "4) $(tr m4_restart)"
    echo "5) $(tr m4_logs)"
    echo "6) $(tr m5_sync)"
    echo "7) $(tr m6_rpc)"
    echo "8) $(tr m7_remove)"
    echo "9) $(tr m8_lang)"
    echo "10) $(tr m9_colors)"
    echo "11) $(tr m10_exit)"
    read -rp "> " choice
    case "$choice" in      1) bootstrap_setup ;;
      2) create_dir_and_env_and_compose ;;
      3) start_node ;;
      4) restart_node ;;
      5) show_logs ;;
      6) run_sync_check ;;
      7) check_rpc_health ;;
      8) remove_node ;;
      9) choose_language ;;
      10) toggle_colors ;;
      11) exit 0 ;;
      *) ;;
    esac
    echo -e "
$(tr press_enter)"; read -r
  done
}

main_menu
